<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayray no Kilomaâ€™anï½œè±å¹´ç¥­çš„ç¨‹åº</title>
    <style>
        /* åŸºæœ¬é é¢æ¨£å¼ï¼Œè‹±æ–‡å­—é«”å„ªå…ˆä½¿ç”¨ Times New Roman */
        body { 
            font-family: "Times New Roman", "Noto Sans TC", sans-serif; 
            background-color: #f7f6ef; 
            color: #333; 
            margin: 0; 
            padding: 0; /* ç§»é™¤ body çš„ padding */
        }
        .container { max-width: 800px; margin: auto; text-align: center; padding: 1em; /* å°‡ padding ç§»åˆ° container */ }
        
        /* --- âœ¨ æ–°å¢é¦–é å‹•ç•«æ¨£å¼ (å·²é‡æ–°å‘½åä»¥å€åˆ†å±¤æ¬¡) --- */
        /* Adjusted for 5 splash screens starting from #splash-screen-1 */
        #splash-screen-1, #splash-screen-2, #splash-screen-3, #splash-screen-4, #splash-screen-5 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: flex;
            flex-direction: column; /* For stacking button on video */
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out;
            overflow: hidden; /* Ensure video doesn't overflow */
        }
        /* Hide all splash screens initially except the very first one */
        #splash-screen-2, #splash-screen-3, #splash-screen-4, #splash-screen-5 { 
            display: none; 
        }

        /* Unified video styles for all splash screens */
        #splash-video-1, #splash-video-2, #splash-video-3, #splash-video-4, #splash-video-5 { 
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed from 'cover' to 'contain' to prevent cropping */
            transform: translate(-50%, -50%);
            /* Ensures it fits within the parent div, showing black bars if aspect ratio differs */
        }

        /* Unified button styles for all splash screens */
        #enter-btn-1, #enter-btn-2, #enter-btn-3, #enter-btn-4, #enter-btn-5 { 
            position: relative; 
            z-index: 2001;
            padding: 15px 35px;
            font-size: 1.5em;
            color: white;
            background-color: rgba(48, 80, 48, 0.7);
            border: 2px solid white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px; /* Space from content above */
        }
        #enter-btn-1:hover, #enter-btn-2:hover, #enter-btn-3:hover, #enter-btn-4:hover, #enter-btn-5:hover { 
            background-color: rgba(48, 80, 48, 0.9);
            transform: scale(1.05);
        }
        
        /* Unified sound control buttons */
        #volume-btn-1, #volume-btn-2, #volume-btn-3, #volume-btn-4, #volume-btn-5 { 
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 2001;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Unified back buttons for splash screens */
        #back-btn-1, #back-btn-2, #back-btn-3, #back-btn-4, #back-btn-5 { 
            position: absolute;
            top: 20px; 
            left: 20px; 
            z-index: 2001;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: white; 
            padding: 5px 10px;
        }
        #back-btn-1:hover, #back-btn-2:hover, #back-btn-3:hover, #back-btn-4:hover, #back-btn-5:hover { 
            color: #ccc;
        }

        #main-content {
            display: none; /* Default hidden main content */
            opacity: 0;
            transition: opacity 1s ease-in;
        }

        /* --- âœ¨ Header styles --- */
        .page-header {
            display: flex;
            justify-content: space-between; /* Align elements apart */
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #e8e6d9;
            margin-bottom: 1.5em;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* Specific logo styles for header */
        #county-logo { /* New ID for "è‡ºæ±ç¸£æœ¬åœŸèªæ•™å­¸" logo */
            max-height: 50px; /* Standard size for main logo */
        }
        #instructor-logo { /* ID for "è˜¿æ‹‰éº»å‰ Rolla Moggi" logo */
            max-height: 30px; /* Smaller size for instructor logo */
            margin-left: 5px; /* Adjust spacing if needed */
        }
        .page-header .instructor-name {
            font-size: 1em;
            color: #555;
            white-space: nowrap; /* Prevent instructor name from wrapping */
        }

        #back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            padding: 5px 10px;
        }
        #back-btn:hover {
            color: #000;
        }


        h1, h2 { text-align: center; color: #305030; }
        
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: -10px;
        }

        /* --- âœ¨ Lesson navigation & Quiz sections --- */
        .lesson-nav, .quiz-section, .full-text-section {
            background-color: #e8e6d9;
            padding: 1.5em;
            border-radius: 12px;
            margin: 1.5em 0;
        }
        .lesson-nav h3, .quiz-section h3, .full-text-section h3 {
            margin-top: 0;
            color: #305030;
            border-bottom: 2px solid #c9c7b9;
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .lesson-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .lesson-links a, .quiz-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }
        .lesson-links a:hover, .quiz-btn:hover {
            background-color: #305030;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* âœ¨ Online quiz section styles (Option 1: Focus on single quiz) */
        .quiz-content {
            padding: 1.5em 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .quiz-content p {
            margin: 0;
            font-size: 1.2em;
        }
        .quiz-item img {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quiz-btn {
            font-size: 1.2em;
            padding: 12px 28px;
        }
        
        /* âœ¨ Full text overview */
        .full-text-section .overview-container {
            position: relative;
        }
        /* Explicitly define object-fit: contain for this image */
        .full-text-section img {
            width: 80%; /* Adjusted to 80% as requested */
            max-width: 600px; /* Keep max width to control size on very large screens */
            height: auto; /* Maintain aspect ratio */
            object-fit: contain; /* Ensure entire image is visible, preventing cropping */
            border-radius: 8px;
            display: block;
            margin: 0 auto; /* Center the image */
        }

        .overview-play-btn {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.05); /* Adjusted to match other play buttons */
            border: 1px solid #ccc; /* Adjusted to match other play buttons */
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            width: 40px; /* Matched size with .play-btn */
            height: 40px; /* Matched size with .play-btn */
            font-size: 1.5em; /* Matched font size with .play-btn */
        }
        .overview-play-btn:hover {
            background-color: #e9e9e9; /* Adjusted to match other play buttons */
        }

        /* Positions for overview buttons */
        #overview-btn-title { top: 7.0%; left: 3.5%; } 
        #overview-btn-1 { top: 17.0%; left: 3.5%; } 
        #overview-btn-2 { top: 26.0%; left: 3.5%; } 
        #overview-btn-3 { top: 34.8%; left: 3.5%; } 
        #overview-btn-4 { top: 46.8%; left: 3.5%; } 
        #overview-btn-5 { top: 56.1%; left: 3.5%; } 
        #overview-btn-6 { top: 68.5%; left: 3.5%; } 
        #overview-btn-7 { top: 77.3%; left: 3.5%; } 
        #overview-btn-8 { top: 86.0%; left: 3.5%; } 


        /* --- New text and button layout --- */
        .lesson-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 2em;
            text-align: left;
            margin-top: 1.5em;
        }

        .sentence-line {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 1.5em;
        }
        
        .sentence-line:last-child {
            margin-bottom: 0;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .play-btn, .gemini-btn {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid #ccc;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            font-family: "Times New Roman", sans-serif; /* Ensure icon characters display */
        }
        
        .play-btn { width: 40px; height: 40px; font-size: 1.5em; }
        .gemini-btn { width: 32px; height: 32px; font-size: 0.9em; }

        .play-btn:hover, .gemini-btn:hover {
            background-color: #e9e9e9;
        }

        .sentence-text {
            flex-grow: 1;
            font-size: 1.5em;
            line-height: 1.8;
            margin: 0;
            padding-top: 5px;
        }

        /* âœ¨ Tap-to-translate styles */
        .word {
            cursor: pointer;
            border-bottom: 2px dotted #aaa;
            transition: background-color 0.2s;
        }
        .word:hover {
            background-color: #e8f4f8;
        }
        .word.highlighted-phrase { /* Style for highlighted phrase (red) */
            background-color: #ffcccc; /* Light red background */
            font-weight: bold;
        }
        .word.highlighted-single-word { /* Style for highlighted single word (blue) */
            background-color: #cceeff; /* Light blue background */
            font-weight: bold;
        }

        /* Translation tooltip */
        #tooltip {
            position: absolute;
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1em;
            z-index: 1010;
            display: none; /* Default hidden */
            pointer-events: none; /* Prevent tooltip from blocking events */
        }
        
        /* --- Original Gemini buttons and Modal styles --- */
        .culture-btn {
            font-family: "Times New Roman", "Noto Sans TC", sans-serif;
            margin-top: 25px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: #305030;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .culture-btn:hover { background-color: #486e48; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 600px; max-height: 80vh;
            overflow-y: auto; position: relative; text-align: left; line-height: 1.8;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; font-size: 28px;
            font-weight: bold; cursor: pointer; color: #888;
        }
        .modal-close:hover { color: #333; }
        .modal-title { margin-top: 0; color: #305030;}
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #305030;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI Chat Modal styles removed */

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .page-header {
                justify-content: space-between;
            }
            .header-info {
                gap: 10px;
            }
            .sentence-text {
                font-size: 1.2em; /* Smaller font size for mobile */
            }
            /* Adjusted for consistency on mobile */
            .play-btn { width: 35px; height: 35px; font-size: 1.3em;}
            .gemini-btn { width: 28px; height: 28px; font-size: 0.8em; }
            .overview-play-btn { 
                width: 35px; 
                height: 35px; 
                font-size: 1.3em;
            }
            /* Unified splash screen video styles for mobile */
            #splash-video-1,
            #splash-video-2,
            #splash-video-3,
            #splash-video-4,
            #splash-video-5 {
                position: absolute; /* Changed to absolute for full screen fill */
                top: 50%;
                left: 50%;
                width: 100%;
                height: 100%;
                object-fit: contain; /* Cover the whole area */
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <!-- âœ¨ Splash Screen 1 (New First Page - Video + Button) -->
    <div id="splash-screen-1">
        <video id="splash-video-1" autoplay muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750685485/a0f94667-ca08-4b35-8a0a-a29b28355797_zdtslz.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
        </video>
        <button id="enter-btn-1">é€²å…¥èª²ç¨‹</button>
        <button id="volume-btn-1">ğŸ”ˆ</button>
    </div>

    <!-- âœ¨ Splash Screen 2 (Original splash0, now 2nd page) -->
    <div id="splash-screen-2">
        <video id="splash-video-2" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750694133/kiloma_an_p1_imabpm.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
        </video>
        <button id="enter-btn-2">é€²å…¥èª²ç¨‹</button>
        <button id="volume-btn-2">ğŸ”ˆ</button>
        <button id="back-btn-2">â†©ï¸</button>
    </div>

    <!-- âœ¨ Splash Screen 3 (Original splashA, now 3rd page) -->
    <div id="splash-screen-3">
        <video id="splash-video-3" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750665618/%E5%A4%A7%E5%AF%8C%E7%BF%81%E5%8B%95%E7%95%AB_fwbjxs.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
        </video>
        <button id="enter-btn-3">é€²å…¥èª²ç¨‹</button>
        <button id="volume-btn-3">ğŸ”ˆ</button>
        <button id="back-btn-3">â†©ï¸</button>
    </div>

    <!-- âœ¨ Splash Screen 4 (Original splashB, now 4th page) -->
    <div id="splash-screen-4">
        <video id="splash-video-4" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750684378/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_2_qjc4ix.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
        </video>
        <button id="enter-btn-4">é€²å…¥èª²ç¨‹</button>
        <button id="volume-btn-4">ğŸ”ˆ</button>
        <button id="back-btn-4">â†©ï¸</button>
    </div>

    <!-- âœ¨ Splash Screen 5 (Original splashC, now 5th page) -->
    <div id="splash-screen-5">
        <video id="splash-video-5" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750689764/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_6_vvz732.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
        </video>
        <button id="enter-btn-5">é€²å…¥èª²ç¨‹</button>
        <button id="volume-btn-5">ğŸ”ˆ</button>
        <button id="back-btn-5">â†©ï¸</button>
    </div>

    <main id="main-content">
        <div class="container">
            
            <header class="page-header">
                <div class="header-left">
                    <button id="back-btn">â†©ï¸</button>
                    <!-- Restored the county logo and gave it an ID -->
                    <img id="county-logo" src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750667116/ChatGPT_Image_2025%E5%B9%B46%E6%9C%886%E6%97%A5_%E4%B8%8B%E5%8D%8803_49_10_g50dif.png" alt="è‡ºæ±ç¸£æœ¬åœŸèªæ•™å­¸ Logo">
                    <p class="instructor-name">è‡ºæ±ç¸£æœ¬åœŸèªåœ˜</p>
                </div>
                <div class="header-right">
                    <p class="instructor-name">æˆèª²æ•™å¸«ï¼šè˜¿æ‹‰éº»å‰ Rolla Moggi</p>
                    <!-- Kept the instructor logo and gave it an ID for specific sizing -->
                    <img id="instructor-logo" src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1749659604/vxem1akzssudvs0neffn.png" alt="Logo" class="logo">
                </div>
            </header>

            <div class="title-container">
                <h1>Rayray no Kilomaâ€™an</h1>
                <button class="play-btn" data-audio="audio-title">â–¶</button>
            </div>
            <h2>ğŸ“– è±å¹´ç¥­çš„ç¨‹åºï½œèª²æ–‡æœ—è®€ç·´ç¿’</h2>

            <!-- âœ¨ Lesson navigation section -->
            <nav class="lesson-nav">
                <h3>æ–‡åŒ–èª²ç¨‹åˆ—è¡¨</h3>
                <ul class="lesson-links">
                    <li><a href="https://www.youtube.com/watch?v=zkV900qsffY" target="_blank" rel="noopener noreferrer">ç¬¬1å ‚èª²ï¼šè±å¹´ç¥­çš„ä»‹ç´¹</a></li>
                    <li><a href="https://www.youtube.com/watch?v=cxPQUPFRUfI" target="_blank" rel="noopener noreferrer">ç¬¬2å ‚èª²ï¼šé¦¬è˜­è±å¹´ç¥­</a></li>
                    <li><a href="https://youtu.be/3O6G_ujIM2I" target="_blank" rel="noopener noreferrer">ç¬¬2å ‚èª²ï¼šéƒ½è˜­è±å¹´ç¥­</a></li>
                    <li><a href="https://www.youtube.com/watch?v=dKtyTTbKBvs" target="_blank" rel="noopener noreferrer">ç¬¬3å ‚èª²ï¼šè¤‡éŸ³å”±æ³•ä»‹ç´¹</a></li>
                    <li><a href="https://reurl.cc/VYvR5y" target="_blank" rel="noopener noreferrer">ç¬¬3å ‚èª²ï¼šé¦¬è˜­è¤‡éŸ³æ­Œè¬ </a></li>
                    <li><a href="https://www.facebook.com/watch/?v=800065338528852" target="_blank" rel="noopener noreferrer">ç¬¬4å ‚èª²ï¼šå°‘å¹´çµ„å­¸ç¿’</a></li>
                    <li><a href="https://www.youtube.com/watch?v=haXUddf3Ygs" target="_blank" rel="noopener noreferrer">ç¬¬4-1å ‚èª²ï¼šå©¦å¥³çµ„æ­Œèˆ</a></li>
                    <li><a href="https://www.youtube.com/watch?v=6milVeLkKN8" target="_blank" rel="noopener noreferrer">ç¬¬4-2å ‚èª²ï¼šå‹‡å£«è­·è¡›èˆ</a></li>
                    <li><a href="https://www.youtube.com/watch?v=GDurQY3ECTo" target="_blank" rel="noopener noreferrer">ç¬¬5å ‚èª²ï¼šå‚³çµ±æ­Œèˆ</a></li>
                    <li><a href="https://www.youtube.com/watch?v=ochU3S1gQNg" target="_blank" rel="noopener noreferrer">ç¬¬5å ‚èª²ï¼šç¾ä»£èˆ</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-singsi/" target="_blank" rel="noopener noreferrer">æ•™å¸«ç¤ºç¯„ç‰ˆå¤§å¯Œç¿</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-mitiliday/" target="_blank" rel="noopener noreferrer">æ—èªå¤§å¯Œç¿ï¼šäº’å‹•æ•™å­¸ç‰ˆ</a></li>
                </ul>
            </nav>

            <!-- âœ¨ Full text overview section -->
            <section class="full-text-section">
                <h3>èª²æ–‡ç¸½è¦½</h3>
                <div class="overview-container">
                    <img src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750739103/lesson_text_fxfgbh.png" alt="èª²æ–‡å…¨æ–‡åœ–ç‰‡">
                    <button class="play-btn overview-play-btn" data-audio="audio-title" id="overview-btn-title">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-1" id="overview-btn-1">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-2" id="overview-btn-2">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-3" id="overview-btn-3">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-4" id="overview-btn-4">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-5" id="overview-btn-5">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-6" id="overview-btn-6">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-7" id="overview-btn-7">â–¶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-8" id="overview-btn-8">â–¶</button>
                </div>
            </section>

            <div class="lesson-content">
                <!-- Sentence content -->
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-title">â–¶</button>
                        <button class="gemini-btn" data-text="Rayray no Kilomaâ€™an.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Rayray no Kilomaâ€™an.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-1">â–¶</button>
                        <button class="gemini-btn" data-text="Faloay ko romi'ad to kilomaâ€™an no Farangaw.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Faloay ko romi'ad to kilomaâ€™an no Farangaw.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-2">â–¶</button>
                        <button class="gemini-btn" data-text="Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-3">â–¶</button>
                        <button class="gemini-btn" data-text="Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-4">â–¶</button>
                        <button class="gemini-btn" data-text="Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-5">â–¶</button>
                    </div>
                    <p class="sentence-text">
                        Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-6">â–¶</button>
                        <button class="gemini-btn" data-text="Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-7">â–¶</button>
                        <button class="gemini-btn" data-text="Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.">ğŸ’¡</button>
                    </div>
                    <p class="sentence-text">
                        Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-8">â–¶</button>
                    </div>
                    <p class="sentence-text">
                        Saikoray a romi'ad mipakerang ko kapot.
                    </p>
                </div>
            </div>
            
            <!-- âœ¨ Online quiz section -->
            <section class="quiz-section">
                <h3>ç¬¬1å ‚èª²ï¼šç«‹å³å…¨ç­æ¸¬é©—</h3>
                <div class="quiz-content">
                    <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æˆ–æƒæ QR Code é€²å…¥æ¸¬é©—</p>
                    <a href="https://wayground.com/join?gc=339281" class="quiz-btn" target="_blank" rel="noopener noreferrer">é€²å…¥ç¬¬1å ‚èª²æ¸¬é©—</a>
                </div>
            </section>

            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 25px;">
                <button id="culture-btn" class="culture-btn">âœ¨ æ¢ç´¢è±å¹´ç¥­æ–‡åŒ–</button>
            </div>
        </div>
    </main>

    <!-- Hidden audio players etc. -->
    <audio id="audio-title" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657545/%E8%AA%B2%E6%96%87rayray_no_kiloma_an_k7hpsw.mp3"></audio>
    <audio id="audio-1" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657974/line2_gti8hy.mp3"></audio>
    <audio id="audio-2" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658020/line3_blpsw6.mp3"></audio>
    <audio id="audio-3" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658115/line4_ngh0nr.mp3"></audio>
    <audio id="audio-4" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658179/line5_omltw4.mp3"></audio>
    <audio id="audio-5" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658270/line6_pf2hef.mp3"></audio>
    <audio id="audio-6" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658330/line7_fg4jqm.mp3"></audio>
    <audio id="audio-7" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658390/line8_qkssrh.mp3"></audio>
    <audio id="audio-8" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658429/line9_txq625.mp3"></audio>

    <!-- Translation tooltip -->
    <div id="tooltip"></div>

    <!-- Modal pop-up window -->
    <div id="gemini-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 class="modal-title">AI å°è€å¸«</h3>
            <div id="modal-body"><div class="loader"></div></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- âœ¨ Splash screen logic (updated for stability) ---
            let currentScreen = 'splash1'; // Start at the very first splash screen

            const splashScreen1 = document.getElementById('splash-screen-1'); 
            const splashVideo1 = document.getElementById('splash-video-1'); 
            const enterBtn1 = document.getElementById('enter-btn-1'); 
            const volumeBtn1 = document.getElementById('volume-btn-1'); 

            const splashScreen2 = document.getElementById('splash-screen-2'); /* New splash screen */
            const splashVideo2 = document.getElementById('splash-video-2'); /* New video for splash2 */
            const enterBtn2 = document.getElementById('enter-btn-2');
            const volumeBtn2 = document.getElementById('volume-btn-2');
            const backBtn2 = document.getElementById('back-btn-2'); 

            const splashScreen3 = document.getElementById('splash-screen-3'); /* Original splash0, now 3rd page */
            const splashVideo3 = document.getElementById('splash-video-3');
            const enterBtn3 = document.getElementById('enter-btn-3');
            const volumeBtn3 = document.getElementById('volume-btn-3');
            const backBtn3 = document.getElementById('back-btn-3'); 

            const splashScreen4 = document.getElementById('splash-screen-4'); /* Original splashA, now 4th page */
            const splashVideo4 = document.getElementById('splash-video-4');
            const enterBtn4 = document.getElementById('enter-btn-4');
            const volumeBtn4 = document.getElementById('volume-btn-4');
            const backBtn4 = document.getElementById('back-btn-4'); 

            const splashScreen5 = document.getElementById('splash-screen-5'); /* Original splashB, now 5th page */
            const splashVideo5 = document.getElementById('splash-video-5');
            const enterBtn5 = document.getElementById('enter-btn-5');
            const volumeBtn5 = document.getElementById('volume-btn-5');
            const backBtn5 = document.getElementById('back-btn-5'); 

            const mainContent = document.getElementById('main-content');
            const backBtn = document.getElementById('back-btn'); 

            const transitionTo = (target) => {
                let currentActiveScreen;
                let currentVideo = null; 
                // Updated currentScreen checks to new numerical IDs
                if (currentScreen === 'splash1') { currentActiveScreen = splashScreen1; currentVideo = splashVideo1; }
                else if (currentScreen === 'splash2') { currentActiveScreen = splashScreen2; currentVideo = splashVideo2; }
                else if (currentScreen === 'splash3') { currentActiveScreen = splashScreen3; currentVideo = splashVideo3; }
                else if (currentScreen === 'splash4') { currentActiveScreen = splashScreen4; currentVideo = splashVideo4; }
                else if (currentScreen === 'splash5') { currentActiveScreen = splashScreen5; currentVideo = splashVideo5; }
                else if (currentScreen === 'main') currentActiveScreen = mainContent;

                // Pause current video if any
                if (currentVideo && !currentVideo.paused) {
                    currentVideo.pause();
                }

                currentActiveScreen.style.opacity = '0';
                currentActiveScreen.addEventListener('transitionend', function handler() {
                    currentActiveScreen.style.display = 'none';
                    currentActiveScreen.removeEventListener('transitionend', handler);

                    let nextActiveScreen;
                    let nextVideo = null; 
                    // Updated target checks to new numerical IDs
                    if (target === 'splash1') { nextActiveScreen = splashScreen1; nextVideo = splashVideo1; }
                    else if (target === 'splash2') { nextActiveScreen = splashScreen2; nextVideo = splashVideo2; }
                    else if (target === 'splash3') { nextActiveScreen = splashScreen3; nextVideo = splashVideo3; }
                    else if (target === 'splash4') { nextActiveScreen = splashScreen4; nextVideo = splashVideo4; }
                    else if (target === 'splash5') { nextActiveScreen = splashScreen5; nextVideo = splashVideo5; }
                    else if (target === 'main') { nextActiveScreen = mainContent; }

                    if (nextVideo) {
                        nextVideo.currentTime = 0; // Rewind
                        // Handle AbortError for video play attempts
                        nextVideo.play().then(() => {
                            console.log(`Successfully played: ${target} video.`);
                        }).catch(error => {
                            if (error.name === 'AbortError') {
                                console.warn(`Video playback for ${target} was aborted (likely by user quick-clicking).`);
                            } else {
                                console.error(`Error playing video for ${target}:`, error);
                            }
                        });
                    }

                    nextActiveScreen.style.display = (target.startsWith('splash')) ? 'flex' : 'block'; 
                    void nextActiveScreen.offsetWidth; // Trigger reflow
                    nextActiveScreen.style.opacity = '1';
                    currentScreen = target;
                }, { once: true });
            };

            enterBtn1.addEventListener('click', () => transitionTo('splash2')); 
            enterBtn2.addEventListener('click', () => transitionTo('splash3')); 
            enterBtn3.addEventListener('click', () => transitionTo('splash4')); 
            enterBtn4.addEventListener('click', () => transitionTo('splash5')); 
            enterBtn5.addEventListener('click', () => transitionTo('main')); 

            backBtn.addEventListener('click', () => { 
                if (currentScreen === 'main') {
                    transitionTo('splash5'); 
                } 
            });

            backBtn5.addEventListener('click', () => { 
                if (currentScreen === 'splash5') { 
                    transitionTo('splash4'); 
                }
            });

            backBtn4.addEventListener('click', () => { 
                if (currentScreen === 'splash4') { 
                    transitionTo('splash3'); 
                }
            });

            backBtn3.addEventListener('click', () => { 
                if (currentScreen === 'splash3') { 
                    transitionTo('splash2'); 
                }
            });

            backBtn2.addEventListener('click', () => { 
                if (currentScreen === 'splash2') {
                    transitionTo('splash1');
                }
            });


            // Updated volume button event listeners
            volumeBtn1.addEventListener('click', () => { 
                splashVideo1.muted = !splashVideo1.muted;
                volumeBtn1.textContent = splashVideo1.muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
            });
            volumeBtn2.addEventListener('click', () => { 
                splashVideo2.muted = !splashVideo2.muted;
                volumeBtn2.textContent = splashVideo2.muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
            });
            volumeBtn3.addEventListener('click', () => { 
                splashVideo3.muted = !splashVideo3.muted;
                volumeBtn3.textContent = volumeBtn3.muted ? 'ğŸ”ˆ' : 'ğŸ”Š'; 
            });
            volumeBtn4.addEventListener('click', () => { 
                splashVideo4.muted = !splashVideo4.muted;
                volumeBtn4.textContent = volumeBtn4.muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
            });
            volumeBtn5.addEventListener('click', () => { 
                splashVideo5.muted = !splashVideo5.muted;
                volumeBtn5.textContent = volumeBtn5.muted ? 'ğŸ”ˆ' : 'ğŸ”Š';
            });

            // Initial state: show splash screen 1 and play video
            splashScreen1.style.display = 'flex';
            splashVideo1.play().then(() => {
                console.log("Initial splash1 video played successfully.");
            }).catch(error => {
                if (error.name === 'NotAllowedError') {
                    console.warn("Autoplay for splash1 blocked. User interaction needed.");
                } else if (error.name !== 'AbortError') {
                    console.error("Error playing initial splash1 video:", error);
                }
            });


            // --- âœ¨ Smart Dictionary (updated) ---
            const vocabulary = {
                "Rayray": "ç¨‹åº", 
                "Faloay": "å…« (æ•¸å­—)", 
                "ko": "ä¸»æ ¼", 
                "romi'ad": "å¤©; å¤©æ°£", 
                "to": "æ–œæ ¼", 
                "kilomaâ€™an": "è±å¹´ç¥­", "no": "ï¼ˆå±¬æ ¼ï¼‰",
                "Farangaw": "é¦¬è˜­ç¤¾", 
                "Sa'ayaw": "æœ€å…ˆ", 
                "Sa'ayaw_a_romi'ad": "ç¬¬ä¸€å¤©", 
                "misahafay": "æº–å‚™æ—¥",
                "mirekal": "å ±è¨Š", 
                "i": "åœ¨... (ä»‹ç¹«è©)", 
                "taliyok_no_niyaro'": "éƒ¨è½å‘¨åœ",
                "milikakawa": "æº–å‚™å™¨å…·/å•Ÿç¨‹", 
                "lalosidan": "å‚³çµ±å™¨å…·",
                "Sakatosa_a_romi'ad": "ç¬¬äºŒå¤©", "panemnem": "çµ¦æ³‰æ°´", "tahidang_to_liteng": "è¿è«‹ç¥–éˆ",
                "misatora": "ç¥ˆéˆ", "pacaedong_to_miromromay": "é’å¹´é ˜å°æ¥å—äº¤ä»»å‹™",
                "mitaowak_to_kaetohay": "é£²ç›¡è’¸é¤¾é…’", "Sakatolo_a_romi'ad": "ç¬¬ä¸‰å¤©",
                "pafata'an_pacelem": "ä¸€æ—©æ¸…é»äººæ•¸", 
                "na_malingad_talariyal_mikesi'": "æ‰å‡ºç™¼åˆ°æµ·é‚Šèˆ‰è¡Œæµ·ç¥­", 
                "Sakasepat_ato_sakalima_a_romi'ad": "ç¬¬å››ã€äº”å¤©", 
                "saromi'ad_mikesi'_i_riyal": "é’å¹´æ•´å¤©åœ¨æµ·é‚Š", 
                "micelem": "æ½›æ°´", "micekiw": "æ¡é›†èºè²é¡", "mipacing_ko_kapah": "é’å¹´å°„é­š",
                "ta_palaylay_minokay": "æ‰å¾æµ·é‚Šè·³å‹‡å£«èˆå›åˆ°èšæœƒæ‰€", 
                "palaylay": "å‹‡å£«èˆ", 
                "minokay": "å›å®¶", 
                "Sakaenem_a_romi'ad": "ç¬¬å…­å¤©",
                "misahemay": "æ—æµé€ é£¯(è£½ä½œç³¯ç±³é£¯)", "malikoda_ko_kapah": "é’å¹´å¤§æœƒèˆ",
                "patayra_i_sefi_to_faes_ko_fafahiyan": "å¥³æ€§å¸¶ç±³å»åœ¨èšæœƒæ‰€",
                "palilam_to_titi": "åˆ†è‚‰", "Sakapito_a_romi'ad_pipipay": "ç¬¬ä¸ƒå¤©(æ¯”è³½æ—¥)",
                "mapolong_ko_finawlan_maaides": "å…¨é«”æ—äººç›¸äº’è¼ƒå‹", "masakero": "è·³èˆ", "ato": "å’Œ",
                "malalefod": "äº’ç›¸è³½è·‘", 
                "horirek_panokay_to_liteng": "å®Œæˆå¾Œé€ç¥–éˆå›å®¶",
                "panokay": "é€å›å®¶", 
                "Saikoray": "æœ€å¾Œ", 
                "Saikoray_a_romi'ad": "æœ€åä¸€å¤©", 
                "mipakerang": "å®Œå·¥ç¥­", 
                "mipakerang_ko_kapot": "å¹´é¾„é˜¶å±‚è¿›è¡Œå®Œå·¥ç¥­",
                "kapah": "é’å¹´", 
                "fafahiyan": "å¥³æ€§", 
                "faes": "ç³¯ç±³", 
                "mapolong": "å…¨ä½“", 
                "finawlan": "æ—äºº" 
            };

            const allPlayButtons = document.querySelectorAll('.play-btn');
            const allPlayers = document.querySelectorAll('.audio-player');
            const geminiExplainButtons = document.querySelectorAll('.gemini-btn');
            const cultureBtn = document.getElementById('culture-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const modalCloseBtn = geminiModal.querySelector('.modal-close');
            const modalTitle = geminiModal.querySelector('.modal-title');
            const modalBody = document.getElementById('modal-body'); 
            const tooltip = document.getElementById('tooltip');

            let currentHighlightedWord = null; // Track the currently highlighted word span

            // Function to create clickable word spans
            function createClickableSpans(sentenceText, vocab) {
                let resultHtml = '';
                let tempText = sentenceText; 
                
                // Sort vocabulary keys by length in descending order to prioritize longer phrases
                const sortedKeys = Object.keys(vocab).sort((a, b) => b.length - a.length);

                // Placeholder map to store already processed spans
                const processedSpans = new Map();
                let placeholderCounter = 0;

                // First pass: identify and replace multi-word phrases with placeholders
                for (const key of sortedKeys) {
                    // Check if the key corresponds to a multi-word phrase (contains underscore)
                    // or if it's explicitly a known multi-word phrase like the title.
                    // IMPORTANT: Ensure the regex pattern correctly handles apostrophes and spaces within phrases.
                    let pattern;
                    if (key.includes('_')) {
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/_/g, '[\\sâ€™\\-]*');
                    } else {
                        // For single words or keys without underscore, match them directly.
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Regex to find occurrences. Use a non-capturing group for the pattern itself.
                    // Add word boundaries for more precise matching of whole words/phrases.
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'gi'); 
                    
                    // Use a temporary string for replacement to avoid issues with already wrapped content
                    let newTempText = tempText.replace(regex, (match) => {
                        // Only replace if it's not a placeholder from a previous, longer match
                        if (!match.startsWith('__PH_')) { 
                            const placeholder = `__PH_${placeholderCounter++}__`;
                            // Store the original matched text with its data-key
                            processedSpans.set(placeholder, `<span class="word" data-key="${key}">${match}</span>`);
                            return placeholder;
                        }
                        return match; // If it's already a placeholder, return it as is
                    });
                    // Only update tempText if changes were made by this regex
                    if (newTempText !== tempText) {
                        tempText = newTempText;
                    }
                }

                // Second pass: Reconstruct the HTML from segments and restore processed spans
                let finalParts = [];
                // Split by the generated placeholders to process the remaining plain text parts
                const segments = tempText.split(/(__PH_\d+__)/g);

                segments.forEach(segment => {
                    if (segment.startsWith('__PH_') && processedSpans.has(segment)) {
                        finalParts.push(processedSpans.get(segment)); // Restore the previously wrapped phrase
                    } else {
                        // Process the remaining plain text segment for single words that might not have been part of a multi-word phrase
                        // This regex matches sequences of word characters (including optional internal apostrophes) or individual non-word characters (like punctuation, spaces)
                        const individualTokens = segment.match(/(\b\w+'?\w*\b|[^\w\s])/g); 
                        
                        if (individualTokens) {
                            individualTokens.forEach(token => {
                                let cleanedToken = token.replace(/[,.'â€™\s]/g, ''); 
                                if (vocab[cleanedToken]) {
                                    finalParts.push(`<span class="word" data-key="${cleanedToken}">${token}</span>`);
                                } else {
                                    finalParts.push(token); // Add original token if no vocabulary match
                                }
                            });
                        } else {
                            finalParts.push(segment); // Fallback if segment cannot be further tokenized
                        }
                    }
                });

                return finalParts.join('').trim();
            }


            const sentences = [
                "Rayray no Kilomaâ€™an.",
                "Faloay ko romi'ad to kilomaâ€™an no Farangaw.",
                "Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.",
                "Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.",
                "Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.",
                "Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.",
                "Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.",
                "Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.", 
                "Saikoray a romi'ad mipakerang ko kapot."
            ];

            const sentenceElements = document.querySelectorAll('.lesson-content .sentence-line');
            sentenceElements.forEach((lineElement, index) => {
                const playButton = lineElement.querySelector('.play-btn');
                const geminiButton = lineElement.querySelector('.gemini-btn');
                
                // Ensure geminiButton exists before accessing its dataset
                if (geminiButton) { 
                    geminiButton.dataset.text = sentences[index];
                }

                // Manually construct the clickable spans for the Amis sentence text
                const sentenceTextElement = lineElement.querySelector('.sentence-text');
                if (sentenceTextElement) { // Ensure text element exists
                    sentenceTextElement.innerHTML = createClickableSpans(sentences[index], vocabulary);
                }
            });
            
            // --- Audio playback logic (fixed) ---
            allPlayButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetAudioId = button.dataset.audio;
                    const targetPlayer = document.getElementById(targetAudioId);
                    console.log(`Attempting to play: ${targetAudioId}`); // Log which audio is being targeted
                    if (!targetPlayer) {
                        console.error(`Audio element not found: ${targetAudioId}`);
                        return;
                    }

                    const isCurrentlyPlaying = !targetPlayer.paused;

                    if (isCurrentlyPlaying) {
                        targetPlayer.pause();
                        console.log(`Paused: ${targetAudioId}`);
                    } else {
                        allPlayers.forEach(p => {
                            if (p !== targetPlayer) {
                                p.pause();
                                p.currentTime = 0; // Rewind paused audios
                                console.log(`Paused and rewound other audio: ${p.id}`);
                            }
                        });
                        targetPlayer.play().then(() => {
                            console.log(`Successfully played: ${targetAudioId}`);
                        }).catch(error => { // Changed 'err' to 'error' for consistency
                            if (error.name === 'NotAllowedError') {
                                console.warn(`Autoplay/playback blocked for ${targetAudioId}. User interaction may be required.`);
                            } else if (error.name === 'AbortError') { // Catch AbortError specifically
                                console.warn(`Playback for ${targetAudioId} was aborted (expected in rapid transitions).`);
                            }
                            else {
                                console.error(`Playback error for ${targetAudioId}:`, error);
                            }
                        });
                    }
                });
            });

            allPlayers.forEach(player => {
                // Update button text when audio plays
                player.addEventListener('play', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = 'âšâš'; // Set pause icon
                    });
                });

                // Update button text when audio pauses or ends
                player.addEventListener('pause', () => { 
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = 'â–¶'; // Set play icon
                    });
                });

                // Ensure icon resets when audio finishes naturally
                player.addEventListener('ended', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = 'â–¶'; // Set play icon
                    });
                });
            });
            
            // --- Gemini API call logic (for detailed explanation) ---
            const callGemini = async (prompt, modalBodyElement) => {
                modalBodyElement.innerHTML = '<div class="loader"></div>';

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed, status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Unexpected response format from API.');
                    }
                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    return `ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚<br>(${error.message})`;
                }
            };
            
            // --- Modal general logic ---
            const setupModal = (modalElement) => { 
                const closeBtn = modalElement.querySelector('.modal-close');
                
                closeBtn.addEventListener('click', () => modalElement.style.display = 'none');
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        modalElement.style.display = 'none';
                    }
                });
            };

            setupModal(geminiModal);

            // --- Tap-to-translate logic (Enhanced for highlighting and positioning) ---
            const wordsContainer = document.querySelector('.lesson-content'); // Container for words
            wordsContainer.addEventListener('click', (e) => {
                // Clear highlight from previously highlighted word/phrase
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
                tooltip.style.display = 'none'; // Hide tooltip on any click outside a word

                // Check if the clicked element is a word span
                let targetWordSpan = e.target.closest('.word');

                if (targetWordSpan) {
                    e.stopPropagation(); // Prevent document.body click from immediately hiding tooltip
                    
                    const key = targetWordSpan.dataset.key;
                    const translation = vocabulary[key];
                    
                    if (translation) {
                        tooltip.textContent = translation;
                        const rect = targetWordSpan.getBoundingClientRect();
                        
                        // Temporarily show tooltip to get its dimensions
                        tooltip.style.display = 'block';
                        const tooltipHeight = tooltip.offsetHeight;
                        const tooltipWidth = tooltip.offsetWidth;
                        
                        // Calculate positions
                        const spaceAbove = rect.top;
                        const spaceBelow = window.innerHeight - rect.bottom;
                        
                        let topPosition;
                        if (spaceAbove > tooltipHeight + 5) { // Prefer above if enough space
                            topPosition = rect.top + window.scrollY - tooltipHeight - 5;
                        } else if (spaceBelow > tooltipHeight + 5) { // Otherwise, prefer below if enough space
                            topPosition = rect.bottom + window.scrollY + 5;
                        } else { // Fallback: try to place below, centered on screen vertically if too little space
                            topPosition = rect.bottom + window.scrollY + 5; // Default to below
                            // Could add more complex logic here to prevent going off-screen on very small viewports
                        }

                        let leftPosition = rect.left + window.scrollX + (rect.width / 2) - (tooltipWidth / 2);
                        // Adjust if it goes off left edge
                        if (leftPosition < 5) {
                            leftPosition = 5;
                        }
                        // Adjust if it goes off right edge
                        if (leftPosition + tooltipWidth > window.innerWidth - 5) {
                            leftPosition = window.innerWidth - tooltipWidth - 5;
                        }


                        tooltip.style.left = `${leftPosition}px`;
                        tooltip.style.top = `${topPosition}px`;
                        
                        // Determine if it's a multi-word phrase or single word for highlighting
                        // Check if the vocabulary key itself contains '_' for a multi-word phrase,
                        // as the `createClickableSpans` function already sets data-key based on best match.
                        if (key.includes('_')) { 
                            targetWordSpan.classList.add('highlighted-phrase'); // Red for phrases
                        } else {
                            targetWordSpan.classList.add('highlighted-single-word'); // Blue for single words
                        }
                        currentHighlightedWord = targetWordSpan;
                    }
                }
            });

            // Hide tooltip and remove highlight when clicking anywhere else on the body
            document.body.addEventListener('click', () => {
                tooltip.style.display = 'none';
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
            });


            // --- Sentence explanation & cultural exploration logic ---
            geminiExplainButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const sentence = button.dataset.text;

                    modalTitle.innerText = 'ğŸ“– é€å¥è©³è§£';
                    geminiModal.style.display = 'flex';
                    const prompt = `è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€Œæ­£ç¢ºå–®å­—å®šç¾©ã€ï¼Œå°‡é€™å¥é˜¿ç¾èªã€Œ${sentence}ã€ç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼Œä¸¦ç”¨æ¢åˆ—å¼è©³ç´°è§£é‡‹å…¶ä¸­çš„æ–‡æ³•çµæ§‹èˆ‡å–®å­—ã€‚è«‹ä»¥åˆå­¸è€…å®¹æ˜“ç†è§£çš„æ–¹å¼æ–¹å¼èªªæ˜ã€‚

**æ­£ç¢ºå–®å­—å®šç¾©:**
* Faloayï¼šæ•¸å­— "8"
* a romi'adï¼šå¤© (a æ˜¯é€£ç¹«è©)
* koï¼šä¸»æ ¼
* noï¼šå±¬æ ¼
* toï¼šæ–œæ ¼
* mirekalï¼šå ±è¨Š
* taliyok no niyaro'ï¼šéƒ¨è½å‘¨åœ
* milikakawaï¼šæº–å‚™å™¨å…·/å•Ÿç¨‹
* lalosidanï¼šå‚³çµ±å™¨å…·
* misahafayï¼šæº–å‚™æ—¥
* panemnem: çµ¦æ³‰æ°´
* tahidang to liteng: è¿è«‹ç¥–éˆ
* misatora: ç¥ˆéˆ
* pacaedong to miromromay: é’å¹´é ˜å°æ¥å—äº¤ä»»å‹™
* mitaowak to kaetohay: é£²ç›¡è’¸é¤¾é…’
* pafata'an pacelem: ä¸€æ—©æ¸…é»äººæ•¸
* na_malingad_talariyal_mikesi': æ‰å‡ºç™¼åˆ°æµ·é‚Šèˆ‰è¡Œæµ·ç¥­
* saromi'ad_mikesi'_i_riyal: é’å¹´æ•´å¤©åœ¨æµ·é‚Š
* micelem: æ½›æ°´
* micekiw: æ¡é›†èºè²é¡
* mipacing ko kapah: é’å¹´å°„é­š
* ta_palaylay_minokay: æ‰å¾æµ·é‚Šè·³å‹‡å£«èˆå›åˆ°èšæœƒæ‰€
* misahemay: æ—æµé€ é£¯(è£½ä½œç³¯ç±³é£¯)
* malikoda_ko_kapah: é’å¹´å¤§æœƒèˆ
* patayra_i_sefi_to_faes_ko_fafahiyan: å¥³æ€§å¸¶ç±³å»åœ¨èšæœƒæ‰€
* palilam_to_titi: åˆ†è‚‰
* Sakapito_a_romi'ad_pipipay: ç¬¬ä¸ƒå¤©(æ¯”è³½æ—¥)
* mapolong_ko_finawlan_maaides: å…¨é«”æ—äººç›¸äº’è¼ƒå‹
* masakero: è·³èˆ
* malalefod: äº’ç›¸è³½è·‘
* horirek_panokay_to_liteng: å®Œæˆå¾Œé€ç¥–éˆå›å®¶
* Saikoray_a_romi_ad: æœ€å¾Œä¸€å¤©
* mipakerang_ko_kapot: å¹´é½¡éšå±¤é€²è¡Œå®Œå·¥ç¥­
* Rayray: ç¨‹åº
* a: é€£ç¹«è©
* i: åœ¨... (ä»‹ç¹«è©)
* romi'ad: å¤©; å¤©æ°£
* mipakerang: å®Œå·¥ç¥­
* Sa'ayaw: æœ€å…ˆ
* Saikoray: æœ€å¾Œ
* palaylay: å‹‡å£«èˆ
* minokay: å›å®¶
* panokay: é€å›å®¶
* kapah: é’å¹´
* fafahiyan: å¥³æ€§
* faes: ç³¯ç±³
* mapolong: å…¨é«”
* finawlan: æ—äºº

**Analyze target sentence:**
ã€Œ${sentence}ã€

**Your response format should be as follows:**
**Chinese Translation:** [Translate here]

**å–®å­—åˆ†æï¼š**
* [å–®å­—1]ï¼š[è§£é‡‹1]
* [å–®å­—2]ï¼š[è§£é‡‹2]

**æ–‡æ³•çµæ§‹ï¼š**
* [æ–‡æ³•é»1]ï¼š[è§£é‡‹1]
* [æ–‡æ³•é»2]ï¼š[è§£é‡‹2]`;
                    const responseText = await callGemini(prompt, modalBody);
                    modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
                });
            });

            cultureBtn.addEventListener('click', async () => {
                modalTitle.innerText = 'âœ¨ æ¢ç´¢è±å¹´ç¥­æ–‡åŒ–';
                geminiModal.style.display = 'flex';
                // Construct full text from sentences array for cultural context.
                // Assuming `sentences` array contains only the Amis text now.
                const fullText = sentences.join('\n'); 

                const prompt = `I am learning about the Amis Harvest Festival (Kiloma'an) in Taiwan, based on the following Amis text. Please, from the perspective of a language learner interested in culture, provide a detailed explanation in Traditional Chinese of the cultural background and significance of the Harvest Festival, and explain the cultural meaning of the procedures mentioned in this text (e.g., misahafay, panemnem, mikesi', etc.).

**Lesson content for reference:**
${fullText}`;
                const responseText = await callGemini(prompt, modalBody);
                modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
            });
            
        });
    </script>
</body>
</html>
