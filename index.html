<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayray no Kiloma’an｜豐年祭的程序</title>
    <style>
        /* 基本頁面樣式，英文字體優先使用 Times New Roman */
        body { 
            font-family: "Times New Roman", "Noto Sans TC", sans-serif; 
            background-color: #f7f6ef; 
            color: #333; 
            margin: 0; 
            padding: 0; /* 移除 body 的 padding */
        }
        .container { max-width: 800px; margin: auto; text-align: center; padding: 1em; /* 將 padding 移到 container */ }
        
        /* --- ✨ 新增首頁動畫樣式 (已重新命名以區分層次) --- */
        /* Adjusted for 5 splash screens starting from #splash-screen-1 */
        #splash-screen-1, #splash-screen-2, #splash-screen-3, #splash-screen-4, #splash-screen-5 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: flex;
            flex-direction: column; /* For stacking button on video */
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out;
            overflow: hidden; /* Ensure video doesn't overflow */
        }
        /* Hide all splash screens initially except the very first one */
        #splash-screen-2, #splash-screen-3, #splash-screen-4, #splash-screen-5 { 
            display: none; 
        }

        /* Unified video styles for all splash screens */
        #splash-video-1, #splash-video-2, #splash-video-3, #splash-video-4, #splash-video-5 { 
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed from 'cover' to 'contain' to prevent cropping */
            transform: translate(-50%, -50%);
            /* Ensures it fits within the parent div, showing black bars if aspect ratio differs */
        }

        /* Unified button styles for all splash screens */
        #enter-btn-1, #enter-btn-2, #enter-btn-3, #enter-btn-4, #enter-btn-5 { 
            position: relative; 
            z-index: 2001;
            padding: 15px 35px;
            font-size: 1.5em;
            color: white;
            background-color: rgba(48, 80, 48, 0.7);
            border: 2px solid white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px; /* Space from content above */
        }
        #enter-btn-1:hover, #enter-btn-2:hover, #enter-btn-3:hover, #enter-btn-4:hover, #enter-btn-5:hover { 
            background-color: rgba(48, 80, 48, 0.9);
            transform: scale(1.05);
        }
        
        /* Unified sound control buttons */
        #volume-btn-1, #volume-btn-2, #volume-btn-3, #volume-btn-4, #volume-btn-5 { 
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 2001;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Unified back buttons for splash screens */
        #back-btn-1, #back-btn-2, #back-btn-3, #back-btn-4, #back-btn-5 { 
            position: absolute;
            top: 20px; 
            left: 20px; 
            z-index: 2001;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: white; 
            padding: 5px 10px;
        }
        #back-btn-1:hover, #back-btn-2:hover, #back-btn-3:hover, #back-btn-4:hover, #back-btn-5:hover { 
            color: #ccc;
        }

        #main-content {
            display: none; /* Default hidden main content */
            opacity: 0;
            transition: opacity 1s ease-in;
        }

        /* --- ✨ Header styles --- */
        .page-header {
            display: flex;
            justify-content: space-between; /* Align elements apart */
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #e8e6d9;
            margin-bottom: 1.5em;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* Specific logo styles for header */
        #county-logo { /* New ID for "臺東縣本土語教學" logo */
            max-height: 50px; /* Standard size for main logo */
        }
        #instructor-logo { /* ID for "蘿拉麻吉 Rolla Moggi" logo */
            max-height: 30px; /* Smaller size for instructor logo */
            margin-left: 5px; /* Adjust spacing if needed */
        }
        .page-header .instructor-name {
            font-size: 1em;
            color: #555;
            white-space: nowrap; /* Prevent instructor name from wrapping */
        }

        #back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            padding: 5px 10px;
        }
        #back-btn:hover {
            color: #000;
        }


        h1, h2 { text-align: center; color: #305030; }
        
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: -10px;
        }

        /* --- ✨ Lesson navigation & Quiz sections --- */
        .lesson-nav, .quiz-section, .full-text-section {
            background-color: #e8e6d9;
            padding: 1.5em;
            border-radius: 12px;
            margin: 1.5em 0;
        }
        .lesson-nav h3, .quiz-section h3, .full-text-section h3 {
            margin-top: 0;
            color: #305030;
            border-bottom: 2px solid #c9c7b9;
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .lesson-links {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .lesson-links a, .quiz-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }
        .lesson-links a:hover, .quiz-btn:hover {
            background-color: #305030;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* ✨ Online quiz section styles (Option 1: Focus on single quiz) */
        .quiz-content {
            padding: 1.5em 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .quiz-content p {
            margin: 0;
            font-size: 1.2em;
        }
        .quiz-item img {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 3px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .quiz-btn {
            font-size: 1.2em;
            padding: 12px 28px;
        }
        
        /* ✨ Full text overview */
        .full-text-section .overview-container {
            position: relative;
        }
        /* Explicitly define object-fit: contain for this image */
        .full-text-section img {
            width: 80%; /* Adjusted to 80% as requested */
            max-width: 600px; /* Keep max width to control size on very large screens */
            height: auto; /* Maintain aspect ratio */
            object-fit: contain; /* Ensure entire image is visible, preventing cropping */
            border-radius: 8px;
            display: block;
            margin: 0 auto; /* Center the image */
        }

        .overview-play-btn {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.05); /* Adjusted to match other play buttons */
            border: 1px solid #ccc; /* Adjusted to match other play buttons */
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            width: 40px; /* Matched size with .play-btn */
            height: 40px; /* Matched size with .play-btn */
            font-size: 1.5em; /* Matched font size with .play-btn */
        }
        .overview-play-btn:hover {
            background-color: #e9e9e9; /* Adjusted to match other play buttons */
        }

        /* Positions for overview buttons */
        #overview-btn-title { top: 7.0%; left: 3.5%; } 
        #overview-btn-1 { top: 17.0%; left: 3.5%; } 
        #overview-btn-2 { top: 26.0%; left: 3.5%; } 
        #overview-btn-3 { top: 34.8%; left: 3.5%; } 
        #overview-btn-4 { top: 46.8%; left: 3.5%; } 
        #overview-btn-5 { top: 56.1%; left: 3.5%; } 
        #overview-btn-6 { top: 68.5%; left: 3.5%; } 
        #overview-btn-7 { top: 77.3%; left: 3.5%; } 
        #overview-btn-8 { top: 86.0%; left: 3.5%; } 


        /* --- New text and button layout --- */
        .lesson-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 2em;
            text-align: left;
            margin-top: 1.5em;
        }

        .sentence-line {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 1.5em;
        }
        
        .sentence-line:last-child {
            margin-bottom: 0;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .play-btn, .gemini-btn {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid #ccc;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            font-family: "Times New Roman", sans-serif; /* Ensure icon characters display */
        }
        
        .play-btn { width: 40px; height: 40px; font-size: 1.5em; }
        .gemini-btn { width: 32px; height: 32px; font-size: 0.9em; }

        .play-btn:hover, .gemini-btn:hover {
            background-color: #e9e9e9;
        }

        .sentence-text {
            flex-grow: 1;
            font-size: 1.5em;
            line-height: 1.8;
            margin: 0;
            padding-top: 5px;
        }

        /* ✨ Tap-to-translate styles */
        .word {
            cursor: pointer;
            border-bottom: 2px dotted #aaa;
            transition: background-color 0.2s;
        }
        .word:hover {
            background-color: #e8f4f8;
        }
        .word.highlighted-phrase { /* Style for highlighted phrase (red) */
            background-color: #ffcccc; /* Light red background */
            font-weight: bold;
        }
        .word.highlighted-single-word { /* Style for highlighted single word (blue) */
            background-color: #cceeff; /* Light blue background */
            font-weight: bold;
        }

        /* Translation tooltip */
        #tooltip {
            position: absolute;
            background-color: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1em;
            z-index: 1010;
            display: none; /* Default hidden */
            pointer-events: none; /* Prevent tooltip from blocking events */
        }
        
        /* --- Original Gemini buttons and Modal styles --- */
        .culture-btn {
            font-family: "Times New Roman", "Noto Sans TC", sans-serif;
            margin-top: 25px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: #305030;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .culture-btn:hover { background-color: #486e48; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 600px; max-height: 80vh;
            overflow-y: auto; position: relative; text-align: left; line-height: 1.8;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; font-size: 28px;
            font-weight: bold; cursor: pointer; color: #888;
        }
        .modal-close:hover { color: #333; }
        .modal-title { margin-top: 0; color: #305030;}
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #305030;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI Chat Modal styles removed */

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .page-header {
                justify-content: space-between;
            }
            .header-info {
                gap: 10px;
            }
            .sentence-text {
                font-size: 1.2em; /* Smaller font size for mobile */
            }
            /* Adjusted for consistency on mobile */
            .play-btn { width: 35px; height: 35px; font-size: 1.3em;}
            .gemini-btn { width: 28px; height: 28px; font-size: 0.8em; }
            .overview-play-btn { 
                width: 35px; 
                height: 35px; 
                font-size: 1.3em;
            }
            /* Unified splash screen video styles for mobile */
            #splash-video-1,
            #splash-video-2,
            #splash-video-3,
            #splash-video-4,
            #splash-video-5 {
                position: absolute; /* Changed to absolute for full screen fill */
                top: 50%;
                left: 50%;
                width: 100%;
                height: 100%;
                object-fit: contain; /* Cover the whole area */
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <!-- ✨ Splash Screen 1 (New First Page - Video + Button) -->
    <div id="splash-screen-1">
        <video id="splash-video-1" autoplay muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750685485/a0f94667-ca08-4b35-8a0a-a29b28355797_zdtslz.mp4" type="video/mp4">
            您的瀏覽器不支援影片播放。
        </video>
        <button id="enter-btn-1">進入課程</button>
        <button id="volume-btn-1">🔈</button>
    </div>

    <!-- ✨ Splash Screen 2 (Original splash0, now 2nd page) -->
    <div id="splash-screen-2">
        <video id="splash-video-2" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750694133/kiloma_an_p1_imabpm.mp4" type="video/mp4">
            您的瀏覽器不支援影片播放。
        </video>
        <button id="enter-btn-2">進入課程</button>
        <button id="volume-btn-2">🔈</button>
        <button id="back-btn-2">↩️</button>
    </div>

    <!-- ✨ Splash Screen 3 (Original splashA, now 3rd page) -->
    <div id="splash-screen-3">
        <video id="splash-video-3" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750665618/%E5%A4%A7%E5%AF%8C%E7%BF%81%E5%8B%95%E7%95%AB_fwbjxs.mp4" type="video/mp4">
            您的瀏覽器不支援影片播放。
        </video>
        <button id="enter-btn-3">進入課程</button>
        <button id="volume-btn-3">🔈</button>
        <button id="back-btn-3">↩️</button>
    </div>

    <!-- ✨ Splash Screen 4 (Original splashB, now 4th page) -->
    <div id="splash-screen-4">
        <video id="splash-video-4" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750684378/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_2_qjc4ix.mp4" type="video/mp4">
            您的瀏覽器不支援影片播放。
        </video>
        <button id="enter-btn-4">進入課程</button>
        <button id="volume-btn-4">🔈</button>
        <button id="back-btn-4">↩️</button>
    </div>

    <!-- ✨ Splash Screen 5 (Original splashC, now 5th page) -->
    <div id="splash-screen-5">
        <video id="splash-video-5" muted loop playsinline>
            <source src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750689764/kiloma_an_%E7%9A%84%E8%A4%87%E6%9C%AC_6_vvz732.mp4" type="video/mp4">
            您的瀏覽器不支援影片播放。
        </video>
        <button id="enter-btn-5">進入課程</button>
        <button id="volume-btn-5">🔈</button>
        <button id="back-btn-5">↩️</button>
    </div>

    <main id="main-content">
        <div class="container">
            
            <header class="page-header">
                <div class="header-left">
                    <button id="back-btn">↩️</button>
                    <!-- Restored the county logo and gave it an ID -->
                    <img id="county-logo" src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750667116/ChatGPT_Image_2025%E5%B9%B46%E6%9C%886%E6%97%A5_%E4%B8%8B%E5%8D%8803_49_10_g50dif.png" alt="臺東縣本土語教學 Logo">
                    <p class="instructor-name">臺東縣本土語團</p>
                </div>
                <div class="header-right">
                    <p class="instructor-name">授課教師：蘿拉麻吉 Rolla Moggi</p>
                    <!-- Kept the instructor logo and gave it an ID for specific sizing -->
                    <img id="instructor-logo" src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1749659604/vxem1akzssudvs0neffn.png" alt="Logo" class="logo">
                </div>
            </header>

            <div class="title-container">
                <h1>Rayray no Kiloma’an</h1>
                <button class="play-btn" data-audio="audio-title">▶</button>
            </div>
            <h2>📖 豐年祭的程序｜課文朗讀練習</h2>

            <!-- ✨ Lesson navigation section -->
            <nav class="lesson-nav">
                <h3>文化課程列表</h3>
                <ul class="lesson-links">
                    <li><a href="https://www.youtube.com/watch?v=zkV900qsffY" target="_blank" rel="noopener noreferrer">第1堂課：豐年祭的介紹</a></li>
                    <li><a href="https://www.youtube.com/watch?v=cxPQUPFRUfI" target="_blank" rel="noopener noreferrer">第2堂課：馬蘭豐年祭</a></li>
                    <li><a href="https://youtu.be/3O6G_ujIM2I" target="_blank" rel="noopener noreferrer">第2堂課：都蘭豐年祭</a></li>
                    <li><a href="https://www.youtube.com/watch?v=dKtyTTbKBvs" target="_blank" rel="noopener noreferrer">第3堂課：複音唱法介紹</a></li>
                    <li><a href="https://reurl.cc/VYvR5y" target="_blank" rel="noopener noreferrer">第3堂課：馬蘭複音歌謠</a></li>
                    <li><a href="https://www.facebook.com/watch/?v=800065338528852" target="_blank" rel="noopener noreferrer">第4堂課：少年組學習</a></li>
                    <li><a href="https://www.youtube.com/watch?v=haXUddf3Ygs" target="_blank" rel="noopener noreferrer">第4-1堂課：婦女組歌舞</a></li>
                    <li><a href="https://www.youtube.com/watch?v=6milVeLkKN8" target="_blank" rel="noopener noreferrer">第4-2堂課：勇士護衛舞</a></li>
                    <li><a href="https://www.youtube.com/watch?v=GDurQY3ECTo" target="_blank" rel="noopener noreferrer">第5堂課：傳統歌舞</a></li>
                    <li><a href="https://www.youtube.com/watch?v=ochU3S1gQNg" target="_blank" rel="noopener noreferrer">第5堂課：現代舞</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-singsi/" target="_blank" rel="noopener noreferrer">教師示範版大富翁</a></li>
                    <li><a href="https://rollamoggi123.github.io/rayray-no-kiloma-an-no-mitiliday/" target="_blank" rel="noopener noreferrer">族語大富翁：互動教學版</a></li>
                </ul>
            </nav>

            <!-- ✨ Full text overview section -->
            <section class="full-text-section">
                <h3>課文總覽</h3>
                <div class="overview-container">
                    <img src="https://res.cloudinary.com/dm1ksvptk/image/upload/v1750739103/lesson_text_fxfgbh.png" alt="課文全文圖片">
                    <button class="play-btn overview-play-btn" data-audio="audio-title" id="overview-btn-title">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-1" id="overview-btn-1">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-2" id="overview-btn-2">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-3" id="overview-btn-3">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-4" id="overview-btn-4">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-5" id="overview-btn-5">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-6" id="overview-btn-6">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-7" id="overview-btn-7">▶</button>
                    <button class="play-btn overview-play-btn" data-audio="audio-8" id="overview-btn-8">▶</button>
                </div>
            </section>

            <div class="lesson-content">
                <!-- Sentence content -->
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-title">▶</button>
                        <button class="gemini-btn" data-text="Rayray no Kiloma’an.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Rayray no Kiloma’an.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-1">▶</button>
                        <button class="gemini-btn" data-text="Faloay ko romi'ad to kiloma’an no Farangaw.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Faloay ko romi'ad to kiloma’an no Farangaw.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-2">▶</button>
                        <button class="gemini-btn" data-text="Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-3">▶</button>
                        <button class="gemini-btn" data-text="Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-4">▶</button>
                        <button class="gemini-btn" data-text="Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-5">▶</button>
                    </div>
                    <p class="sentence-text">
                        Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-6">▶</button>
                        <button class="gemini-btn" data-text="Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-7">▶</button>
                        <button class="gemini-btn" data-text="Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.">💡</button>
                    </div>
                    <p class="sentence-text">
                        Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.
                    </p>
                </div>
                <div class="sentence-line">
                    <div class="button-group">
                        <button class="play-btn" data-audio="audio-8">▶</button>
                    </div>
                    <p class="sentence-text">
                        Saikoray a romi'ad mipakerang ko kapot.
                    </p>
                </div>
            </div>
            
            <!-- ✨ Online quiz section -->
            <section class="quiz-section">
                <h3>第1堂課：立即全班測驗</h3>
                <div class="quiz-content">
                    <p>請點擊下方按鈕或掃描 QR Code 進入測驗</p>
                    <a href="https://wayground.com/join?gc=339281" class="quiz-btn" target="_blank" rel="noopener noreferrer">進入第1堂課測驗</a>
                </div>
            </section>

            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 25px;">
                <button id="culture-btn" class="culture-btn">✨ 探索豐年祭文化</button>
            </div>
        </div>
    </main>

    <!-- Hidden audio players etc. -->
    <audio id="audio-title" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657545/%E8%AA%B2%E6%96%87rayray_no_kiloma_an_k7hpsw.mp3"></audio>
    <audio id="audio-1" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750657974/line2_gti8hy.mp3"></audio>
    <audio id="audio-2" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658020/line3_blpsw6.mp3"></audio>
    <audio id="audio-3" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658115/line4_ngh0nr.mp3"></audio>
    <audio id="audio-4" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658179/line5_omltw4.mp3"></audio>
    <audio id="audio-5" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658270/line6_pf2hef.mp3"></audio>
    <audio id="audio-6" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658330/line7_fg4jqm.mp3"></audio>
    <audio id="audio-7" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658390/line8_qkssrh.mp3"></audio>
    <audio id="audio-8" class="audio-player" src="https://res.cloudinary.com/dm1ksvptk/video/upload/v1750658429/line9_txq625.mp3"></audio>

    <!-- Translation tooltip -->
    <div id="tooltip"></div>

    <!-- Modal pop-up window -->
    <div id="gemini-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 class="modal-title">AI 小老師</h3>
            <div id="modal-body"><div class="loader"></div></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ✨ Splash screen logic (updated for stability) ---
            let currentScreen = 'splash1'; // Start at the very first splash screen

            const splashScreen1 = document.getElementById('splash-screen-1'); 
            const splashVideo1 = document.getElementById('splash-video-1'); 
            const enterBtn1 = document.getElementById('enter-btn-1'); 
            const volumeBtn1 = document.getElementById('volume-btn-1'); 

            const splashScreen2 = document.getElementById('splash-screen-2'); /* New splash screen */
            const splashVideo2 = document.getElementById('splash-video-2'); /* New video for splash2 */
            const enterBtn2 = document.getElementById('enter-btn-2');
            const volumeBtn2 = document.getElementById('volume-btn-2');
            const backBtn2 = document.getElementById('back-btn-2'); 

            const splashScreen3 = document.getElementById('splash-screen-3'); /* Original splash0, now 3rd page */
            const splashVideo3 = document.getElementById('splash-video-3');
            const enterBtn3 = document.getElementById('enter-btn-3');
            const volumeBtn3 = document.getElementById('volume-btn-3');
            const backBtn3 = document.getElementById('back-btn-3'); 

            const splashScreen4 = document.getElementById('splash-screen-4'); /* Original splashA, now 4th page */
            const splashVideo4 = document.getElementById('splash-video-4');
            const enterBtn4 = document.getElementById('enter-btn-4');
            const volumeBtn4 = document.getElementById('volume-btn-4');
            const backBtn4 = document.getElementById('back-btn-4'); 

            const splashScreen5 = document.getElementById('splash-screen-5'); /* Original splashB, now 5th page */
            const splashVideo5 = document.getElementById('splash-video-5');
            const enterBtn5 = document.getElementById('enter-btn-5');
            const volumeBtn5 = document.getElementById('volume-btn-5');
            const backBtn5 = document.getElementById('back-btn-5'); 

            const mainContent = document.getElementById('main-content');
            const backBtn = document.getElementById('back-btn'); 

            const transitionTo = (target) => {
                let currentActiveScreen;
                let currentVideo = null; 
                // Updated currentScreen checks to new numerical IDs
                if (currentScreen === 'splash1') { currentActiveScreen = splashScreen1; currentVideo = splashVideo1; }
                else if (currentScreen === 'splash2') { currentActiveScreen = splashScreen2; currentVideo = splashVideo2; }
                else if (currentScreen === 'splash3') { currentActiveScreen = splashScreen3; currentVideo = splashVideo3; }
                else if (currentScreen === 'splash4') { currentActiveScreen = splashScreen4; currentVideo = splashVideo4; }
                else if (currentScreen === 'splash5') { currentActiveScreen = splashScreen5; currentVideo = splashVideo5; }
                else if (currentScreen === 'main') currentActiveScreen = mainContent;

                // Pause current video if any
                if (currentVideo && !currentVideo.paused) {
                    currentVideo.pause();
                }

                currentActiveScreen.style.opacity = '0';
                currentActiveScreen.addEventListener('transitionend', function handler() {
                    currentActiveScreen.style.display = 'none';
                    currentActiveScreen.removeEventListener('transitionend', handler);

                    let nextActiveScreen;
                    let nextVideo = null; 
                    // Updated target checks to new numerical IDs
                    if (target === 'splash1') { nextActiveScreen = splashScreen1; nextVideo = splashVideo1; }
                    else if (target === 'splash2') { nextActiveScreen = splashScreen2; nextVideo = splashVideo2; }
                    else if (target === 'splash3') { nextActiveScreen = splashScreen3; nextVideo = splashVideo3; }
                    else if (target === 'splash4') { nextActiveScreen = splashScreen4; nextVideo = splashVideo4; }
                    else if (target === 'splash5') { nextActiveScreen = splashScreen5; nextVideo = splashVideo5; }
                    else if (target === 'main') { nextActiveScreen = mainContent; }

                    if (nextVideo) {
                        nextVideo.currentTime = 0; // Rewind
                        // Handle AbortError for video play attempts
                        nextVideo.play().then(() => {
                            console.log(`Successfully played: ${target} video.`);
                        }).catch(error => {
                            if (error.name === 'AbortError') {
                                console.warn(`Video playback for ${target} was aborted (likely by user quick-clicking).`);
                            } else {
                                console.error(`Error playing video for ${target}:`, error);
                            }
                        });
                    }

                    nextActiveScreen.style.display = (target.startsWith('splash')) ? 'flex' : 'block'; 
                    void nextActiveScreen.offsetWidth; // Trigger reflow
                    nextActiveScreen.style.opacity = '1';
                    currentScreen = target;
                }, { once: true });
            };

            enterBtn1.addEventListener('click', () => transitionTo('splash2')); 
            enterBtn2.addEventListener('click', () => transitionTo('splash3')); 
            enterBtn3.addEventListener('click', () => transitionTo('splash4')); 
            enterBtn4.addEventListener('click', () => transitionTo('splash5')); 
            enterBtn5.addEventListener('click', () => transitionTo('main')); 

            backBtn.addEventListener('click', () => { 
                if (currentScreen === 'main') {
                    transitionTo('splash5'); 
                } 
            });

            backBtn5.addEventListener('click', () => { 
                if (currentScreen === 'splash5') { 
                    transitionTo('splash4'); 
                }
            });

            backBtn4.addEventListener('click', () => { 
                if (currentScreen === 'splash4') { 
                    transitionTo('splash3'); 
                }
            });

            backBtn3.addEventListener('click', () => { 
                if (currentScreen === 'splash3') { 
                    transitionTo('splash2'); 
                }
            });

            backBtn2.addEventListener('click', () => { 
                if (currentScreen === 'splash2') {
                    transitionTo('splash1');
                }
            });


            // Updated volume button event listeners
            volumeBtn1.addEventListener('click', () => { 
                splashVideo1.muted = !splashVideo1.muted;
                volumeBtn1.textContent = splashVideo1.muted ? '🔈' : '🔊';
            });
            volumeBtn2.addEventListener('click', () => { 
                splashVideo2.muted = !splashVideo2.muted;
                volumeBtn2.textContent = splashVideo2.muted ? '🔈' : '🔊';
            });
            volumeBtn3.addEventListener('click', () => { 
                splashVideo3.muted = !splashVideo3.muted;
                volumeBtn3.textContent = volumeBtn3.muted ? '🔈' : '🔊'; 
            });
            volumeBtn4.addEventListener('click', () => { 
                splashVideo4.muted = !splashVideo4.muted;
                volumeBtn4.textContent = volumeBtn4.muted ? '🔈' : '🔊';
            });
            volumeBtn5.addEventListener('click', () => { 
                splashVideo5.muted = !splashVideo5.muted;
                volumeBtn5.textContent = volumeBtn5.muted ? '🔈' : '🔊';
            });

            // Initial state: show splash screen 1 and play video
            splashScreen1.style.display = 'flex';
            splashVideo1.play().then(() => {
                console.log("Initial splash1 video played successfully.");
            }).catch(error => {
                if (error.name === 'NotAllowedError') {
                    console.warn("Autoplay for splash1 blocked. User interaction needed.");
                } else if (error.name !== 'AbortError') {
                    console.error("Error playing initial splash1 video:", error);
                }
            });


            // --- ✨ Smart Dictionary (updated) ---
            const vocabulary = {
                "Rayray": "程序", 
                "Faloay": "八 (數字)", 
                "ko": "主格", 
                "romi'ad": "天; 天氣", 
                "to": "斜格", 
                "kiloma’an": "豐年祭", "no": "（屬格）",
                "Farangaw": "馬蘭社", 
                "Sa'ayaw": "最先", 
                "Sa'ayaw_a_romi'ad": "第一天", 
                "misahafay": "準備日",
                "mirekal": "報訊", 
                "i": "在... (介繫詞)", 
                "taliyok_no_niyaro'": "部落周圍",
                "milikakawa": "準備器具/啟程", 
                "lalosidan": "傳統器具",
                "Sakatosa_a_romi'ad": "第二天", "panemnem": "給泉水", "tahidang_to_liteng": "迎請祖靈",
                "misatora": "祈靈", "pacaedong_to_miromromay": "青年領導接受交任務",
                "mitaowak_to_kaetohay": "飲盡蒸餾酒", "Sakatolo_a_romi'ad": "第三天",
                "pafata'an_pacelem": "一早清點人數", 
                "na_malingad_talariyal_mikesi'": "才出發到海邊舉行海祭", 
                "Sakasepat_ato_sakalima_a_romi'ad": "第四、五天", 
                "saromi'ad_mikesi'_i_riyal": "青年整天在海邊", 
                "micelem": "潛水", "micekiw": "採集螺貝類", "mipacing_ko_kapah": "青年射魚",
                "ta_palaylay_minokay": "才從海邊跳勇士舞回到聚會所", 
                "palaylay": "勇士舞", 
                "minokay": "回家", 
                "Sakaenem_a_romi'ad": "第六天",
                "misahemay": "搗杵造飯(製作糯米飯)", "malikoda_ko_kapah": "青年大會舞",
                "patayra_i_sefi_to_faes_ko_fafahiyan": "女性帶米去在聚會所",
                "palilam_to_titi": "分肉", "Sakapito_a_romi'ad_pipipay": "第七天(比賽日)",
                "mapolong_ko_finawlan_maaides": "全體族人相互較勁", "masakero": "跳舞", "ato": "和",
                "malalefod": "互相賽跑", 
                "horirek_panokay_to_liteng": "完成後送祖靈回家",
                "panokay": "送回家", 
                "Saikoray": "最後", 
                "Saikoray_a_romi'ad": "最后一天", 
                "mipakerang": "完工祭", 
                "mipakerang_ko_kapot": "年龄阶层进行完工祭",
                "kapah": "青年", 
                "fafahiyan": "女性", 
                "faes": "糯米", 
                "mapolong": "全体", 
                "finawlan": "族人" 
            };

            const allPlayButtons = document.querySelectorAll('.play-btn');
            const allPlayers = document.querySelectorAll('.audio-player');
            const geminiExplainButtons = document.querySelectorAll('.gemini-btn');
            const cultureBtn = document.getElementById('culture-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const modalCloseBtn = geminiModal.querySelector('.modal-close');
            const modalTitle = geminiModal.querySelector('.modal-title');
            const modalBody = document.getElementById('modal-body'); 
            const tooltip = document.getElementById('tooltip');

            let currentHighlightedWord = null; // Track the currently highlighted word span

            // Function to create clickable word spans
            function createClickableSpans(sentenceText, vocab) {
                let resultHtml = '';
                let tempText = sentenceText; 
                
                // Sort vocabulary keys by length in descending order to prioritize longer phrases
                const sortedKeys = Object.keys(vocab).sort((a, b) => b.length - a.length);

                // Placeholder map to store already processed spans
                const processedSpans = new Map();
                let placeholderCounter = 0;

                // First pass: identify and replace multi-word phrases with placeholders
                for (const key of sortedKeys) {
                    // Check if the key corresponds to a multi-word phrase (contains underscore)
                    // or if it's explicitly a known multi-word phrase like the title.
                    // IMPORTANT: Ensure the regex pattern correctly handles apostrophes and spaces within phrases.
                    let pattern;
                    if (key.includes('_')) {
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/_/g, '[\\s’\\-]*');
                    } else {
                        // For single words or keys without underscore, match them directly.
                        pattern = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    }
                    
                    // Regex to find occurrences. Use a non-capturing group for the pattern itself.
                    // Add word boundaries for more precise matching of whole words/phrases.
                    const regex = new RegExp(`\\b(${pattern})\\b`, 'gi'); 
                    
                    // Use a temporary string for replacement to avoid issues with already wrapped content
                    let newTempText = tempText.replace(regex, (match) => {
                        // Only replace if it's not a placeholder from a previous, longer match
                        if (!match.startsWith('__PH_')) { 
                            const placeholder = `__PH_${placeholderCounter++}__`;
                            // Store the original matched text with its data-key
                            processedSpans.set(placeholder, `<span class="word" data-key="${key}">${match}</span>`);
                            return placeholder;
                        }
                        return match; // If it's already a placeholder, return it as is
                    });
                    // Only update tempText if changes were made by this regex
                    if (newTempText !== tempText) {
                        tempText = newTempText;
                    }
                }

                // Second pass: Reconstruct the HTML from segments and restore processed spans
                let finalParts = [];
                // Split by the generated placeholders to process the remaining plain text parts
                const segments = tempText.split(/(__PH_\d+__)/g);

                segments.forEach(segment => {
                    if (segment.startsWith('__PH_') && processedSpans.has(segment)) {
                        finalParts.push(processedSpans.get(segment)); // Restore the previously wrapped phrase
                    } else {
                        // Process the remaining plain text segment for single words that might not have been part of a multi-word phrase
                        // This regex matches sequences of word characters (including optional internal apostrophes) or individual non-word characters (like punctuation, spaces)
                        const individualTokens = segment.match(/(\b\w+'?\w*\b|[^\w\s])/g); 
                        
                        if (individualTokens) {
                            individualTokens.forEach(token => {
                                let cleanedToken = token.replace(/[,.'’\s]/g, ''); 
                                if (vocab[cleanedToken]) {
                                    finalParts.push(`<span class="word" data-key="${cleanedToken}">${token}</span>`);
                                } else {
                                    finalParts.push(token); // Add original token if no vocabulary match
                                }
                            });
                        } else {
                            finalParts.push(segment); // Fallback if segment cannot be further tokenized
                        }
                    }
                });

                return finalParts.join('').trim();
            }


            const sentences = [
                "Rayray no Kiloma’an.",
                "Faloay ko romi'ad to kiloma’an no Farangaw.",
                "Sa'ayaw a romi'ad misahafay, mirekal i taliyok no niyaro', milikakawa to lalosidan.",
                "Sakatosa a romi'ad panemnem, tahidang to liteng, misatora, pacaedong to miromromay, mitaowak to kaetohay.",
                "Sakatolo a romi'ad, pafata'an pacelem na malingad talariyal mikesi'.",
                "Sakasepat ato sakalima a romi'ad, saromi'ad mikesi' i riyal, micelem, micekiw mipacing ko kapah, ta palaylay minokay.",
                "Sakaenem a romi'ad misahemay, malikoda ko kapah, patayra i sefi to faes ko fafahiyan, palilam to titi.",
                "Sakapito a romi'ad pipipay, mapolong ko finawlan maaides, masakero ato malalefod, horirek panokay to liteng.", 
                "Saikoray a romi'ad mipakerang ko kapot."
            ];

            const sentenceElements = document.querySelectorAll('.lesson-content .sentence-line');
            sentenceElements.forEach((lineElement, index) => {
                const playButton = lineElement.querySelector('.play-btn');
                const geminiButton = lineElement.querySelector('.gemini-btn');
                
                // Ensure geminiButton exists before accessing its dataset
                if (geminiButton) { 
                    geminiButton.dataset.text = sentences[index];
                }

                // Manually construct the clickable spans for the Amis sentence text
                const sentenceTextElement = lineElement.querySelector('.sentence-text');
                if (sentenceTextElement) { // Ensure text element exists
                    sentenceTextElement.innerHTML = createClickableSpans(sentences[index], vocabulary);
                }
            });
            
            // --- Audio playback logic (fixed) ---
            allPlayButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetAudioId = button.dataset.audio;
                    const targetPlayer = document.getElementById(targetAudioId);
                    console.log(`Attempting to play: ${targetAudioId}`); // Log which audio is being targeted
                    if (!targetPlayer) {
                        console.error(`Audio element not found: ${targetAudioId}`);
                        return;
                    }

                    const isCurrentlyPlaying = !targetPlayer.paused;

                    if (isCurrentlyPlaying) {
                        targetPlayer.pause();
                        console.log(`Paused: ${targetAudioId}`);
                    } else {
                        allPlayers.forEach(p => {
                            if (p !== targetPlayer) {
                                p.pause();
                                p.currentTime = 0; // Rewind paused audios
                                console.log(`Paused and rewound other audio: ${p.id}`);
                            }
                        });
                        targetPlayer.play().then(() => {
                            console.log(`Successfully played: ${targetAudioId}`);
                        }).catch(error => { // Changed 'err' to 'error' for consistency
                            if (error.name === 'NotAllowedError') {
                                console.warn(`Autoplay/playback blocked for ${targetAudioId}. User interaction may be required.`);
                            } else if (error.name === 'AbortError') { // Catch AbortError specifically
                                console.warn(`Playback for ${targetAudioId} was aborted (expected in rapid transitions).`);
                            }
                            else {
                                console.error(`Playback error for ${targetAudioId}:`, error);
                            }
                        });
                    }
                });
            });

            allPlayers.forEach(player => {
                // Update button text when audio plays
                player.addEventListener('play', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '❚❚'; // Set pause icon
                    });
                });

                // Update button text when audio pauses or ends
                player.addEventListener('pause', () => { 
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '▶'; // Set play icon
                    });
                });

                // Ensure icon resets when audio finishes naturally
                player.addEventListener('ended', () => {
                    const btns = document.querySelectorAll(`[data-audio="${player.id}"]`);
                    btns.forEach(btn => {
                        btn.textContent = '▶'; // Set play icon
                    });
                });
            });
            
            // --- Gemini API call logic (for detailed explanation) ---
            const callGemini = async (prompt, modalBodyElement) => {
                modalBodyElement.innerHTML = '<div class="loader"></div>';

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed, status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Unexpected response format from API.');
                    }
                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    return `發生錯誤，請稍後再試。<br>(${error.message})`;
                }
            };
            
            // --- Modal general logic ---
            const setupModal = (modalElement) => { 
                const closeBtn = modalElement.querySelector('.modal-close');
                
                closeBtn.addEventListener('click', () => modalElement.style.display = 'none');
                modalElement.addEventListener('click', (e) => {
                    if (e.target === modalElement) {
                        modalElement.style.display = 'none';
                    }
                });
            };

            setupModal(geminiModal);

            // --- Tap-to-translate logic (Enhanced for highlighting and positioning) ---
            const wordsContainer = document.querySelector('.lesson-content'); // Container for words
            wordsContainer.addEventListener('click', (e) => {
                // Clear highlight from previously highlighted word/phrase
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
                tooltip.style.display = 'none'; // Hide tooltip on any click outside a word

                // Check if the clicked element is a word span
                let targetWordSpan = e.target.closest('.word');

                if (targetWordSpan) {
                    e.stopPropagation(); // Prevent document.body click from immediately hiding tooltip
                    
                    const key = targetWordSpan.dataset.key;
                    const translation = vocabulary[key];
                    
                    if (translation) {
                        tooltip.textContent = translation;
                        const rect = targetWordSpan.getBoundingClientRect();
                        
                        // Temporarily show tooltip to get its dimensions
                        tooltip.style.display = 'block';
                        const tooltipHeight = tooltip.offsetHeight;
                        const tooltipWidth = tooltip.offsetWidth;
                        
                        // Calculate positions
                        const spaceAbove = rect.top;
                        const spaceBelow = window.innerHeight - rect.bottom;
                        
                        let topPosition;
                        if (spaceAbove > tooltipHeight + 5) { // Prefer above if enough space
                            topPosition = rect.top + window.scrollY - tooltipHeight - 5;
                        } else if (spaceBelow > tooltipHeight + 5) { // Otherwise, prefer below if enough space
                            topPosition = rect.bottom + window.scrollY + 5;
                        } else { // Fallback: try to place below, centered on screen vertically if too little space
                            topPosition = rect.bottom + window.scrollY + 5; // Default to below
                            // Could add more complex logic here to prevent going off-screen on very small viewports
                        }

                        let leftPosition = rect.left + window.scrollX + (rect.width / 2) - (tooltipWidth / 2);
                        // Adjust if it goes off left edge
                        if (leftPosition < 5) {
                            leftPosition = 5;
                        }
                        // Adjust if it goes off right edge
                        if (leftPosition + tooltipWidth > window.innerWidth - 5) {
                            leftPosition = window.innerWidth - tooltipWidth - 5;
                        }


                        tooltip.style.left = `${leftPosition}px`;
                        tooltip.style.top = `${topPosition}px`;
                        
                        // Determine if it's a multi-word phrase or single word for highlighting
                        // Check if the vocabulary key itself contains '_' for a multi-word phrase,
                        // as the `createClickableSpans` function already sets data-key based on best match.
                        if (key.includes('_')) { 
                            targetWordSpan.classList.add('highlighted-phrase'); // Red for phrases
                        } else {
                            targetWordSpan.classList.add('highlighted-single-word'); // Blue for single words
                        }
                        currentHighlightedWord = targetWordSpan;
                    }
                }
            });

            // Hide tooltip and remove highlight when clicking anywhere else on the body
            document.body.addEventListener('click', () => {
                tooltip.style.display = 'none';
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlighted-phrase');
                    currentHighlightedWord.classList.remove('highlighted-single-word');
                    currentHighlightedWord = null;
                }
            });


            // --- Sentence explanation & cultural exploration logic ---
            geminiExplainButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const sentence = button.dataset.text;

                    modalTitle.innerText = '📖 逐句詳解';
                    geminiModal.style.display = 'flex';
                    const prompt = `請根據以下提供的「正確單字定義」，將這句阿美語「${sentence}」翻譯成繁體中文，並用條列式詳細解釋其中的文法結構與單字。請以初學者容易理解的方式方式說明。

**正確單字定義:**
* Faloay：數字 "8"
* a romi'ad：天 (a 是連繫詞)
* ko：主格
* no：屬格
* to：斜格
* mirekal：報訊
* taliyok no niyaro'：部落周圍
* milikakawa：準備器具/啟程
* lalosidan：傳統器具
* misahafay：準備日
* panemnem: 給泉水
* tahidang to liteng: 迎請祖靈
* misatora: 祈靈
* pacaedong to miromromay: 青年領導接受交任務
* mitaowak to kaetohay: 飲盡蒸餾酒
* pafata'an pacelem: 一早清點人數
* na_malingad_talariyal_mikesi': 才出發到海邊舉行海祭
* saromi'ad_mikesi'_i_riyal: 青年整天在海邊
* micelem: 潛水
* micekiw: 採集螺貝類
* mipacing ko kapah: 青年射魚
* ta_palaylay_minokay: 才從海邊跳勇士舞回到聚會所
* misahemay: 搗杵造飯(製作糯米飯)
* malikoda_ko_kapah: 青年大會舞
* patayra_i_sefi_to_faes_ko_fafahiyan: 女性帶米去在聚會所
* palilam_to_titi: 分肉
* Sakapito_a_romi'ad_pipipay: 第七天(比賽日)
* mapolong_ko_finawlan_maaides: 全體族人相互較勁
* masakero: 跳舞
* malalefod: 互相賽跑
* horirek_panokay_to_liteng: 完成後送祖靈回家
* Saikoray_a_romi_ad: 最後一天
* mipakerang_ko_kapot: 年齡階層進行完工祭
* Rayray: 程序
* a: 連繫詞
* i: 在... (介繫詞)
* romi'ad: 天; 天氣
* mipakerang: 完工祭
* Sa'ayaw: 最先
* Saikoray: 最後
* palaylay: 勇士舞
* minokay: 回家
* panokay: 送回家
* kapah: 青年
* fafahiyan: 女性
* faes: 糯米
* mapolong: 全體
* finawlan: 族人

**Analyze target sentence:**
「${sentence}」

**Your response format should be as follows:**
**Chinese Translation:** [Translate here]

**單字分析：**
* [單字1]：[解釋1]
* [單字2]：[解釋2]

**文法結構：**
* [文法點1]：[解釋1]
* [文法點2]：[解釋2]`;
                    const responseText = await callGemini(prompt, modalBody);
                    modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
                });
            });

            cultureBtn.addEventListener('click', async () => {
                modalTitle.innerText = '✨ 探索豐年祭文化';
                geminiModal.style.display = 'flex';
                // Construct full text from sentences array for cultural context.
                // Assuming `sentences` array contains only the Amis text now.
                const fullText = sentences.join('\n'); 

                const prompt = `I am learning about the Amis Harvest Festival (Kiloma'an) in Taiwan, based on the following Amis text. Please, from the perspective of a language learner interested in culture, provide a detailed explanation in Traditional Chinese of the cultural background and significance of the Harvest Festival, and explain the cultural meaning of the procedures mentioned in this text (e.g., misahafay, panemnem, mikesi', etc.).

**Lesson content for reference:**
${fullText}`;
                const responseText = await callGemini(prompt, modalBody);
                modalBody.innerHTML = responseText.replace(/\n/g, '<br>');
            });
            
        });
    </script>
</body>
</html>
